{% extends "base.html" %}
{% block title %}Scan QR Code{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <div class="bg-white shadow-md rounded-lg p-6">
        <div class="text-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800">Scan QR Code</h1>
            <p class="text-sm text-gray-600 mt-2">Point your camera at the instructor's QR code</p>
        </div>

        <!-- Camera Preview -->
        <div id="reader" class="rounded-lg overflow-hidden mb-4"></div>

        <!-- Start Camera Button -->
        <div class="text-center mb-4">
            <button id="startBtn"
                    class="bg-indigo-600 text-white px-6 py-3 rounded-md hover:bg-indigo-700 font-medium">
                üì∑ Tap to Start Camera
            </button>
        </div>

        <!-- Status Messages -->
        <div id="status" class="text-center mb-4">
            <p class="text-sm text-gray-500">Press the button above to start scanning</p>
        </div>

        <!-- Success/Error Messages -->
        <div id="message" class="hidden mb-4"></div>

        <!-- Manual Entry (backup) -->
        <details class="mt-4">
            <summary class="cursor-pointer text-sm text-gray-600 hover:text-gray-800">
                Can't scan? Enter code manually
            </summary>
            <form id="manualForm" class="mt-4 space-y-3">
                <input type="text"
                       id="manualCode"
                       placeholder="Enter session code"
                       class="w-full px-4 py-2 border border-gray-300 rounded-md">
                <button type="submit"
                        class="w-full bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-700">
                    Submit Code
                </button>
            </form>
        </details>

        <!-- View History Link -->
        <div class="mt-6 text-center">
            <a href="{{ url_for('student.history') }}"
               class="text-sm text-indigo-600 hover:text-indigo-800">
                View Attendance History
            </a>
        </div>
    </div>
</div>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<script>
const messageDiv = document.getElementById('message');
const statusDiv = document.getElementById('status');
const startBtn = document.getElementById('startBtn');
const html5QrCode = new Html5Qrcode("reader");

function showMessage(type, text) {
    messageDiv.className = `p-4 rounded-md ${type === 'success' ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}`;
    messageDiv.textContent = text;
    messageDiv.classList.remove('hidden');
}

async function submitAttendance(content) {
    const response = await fetch('{{ url_for("student.mark_attendance") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        // We just send the "content" now, no more splitting
        body: JSON.stringify({ qr_content: content })
    });

    const result = await response.json();

    if (result.success) {
        showMessage('success', `‚úì ${result.message}`);
        setTimeout(() => window.location.href = '{{ url_for("student.history") }}', 2000);
    } else {
        showMessage('error', `‚ùå ${result.message}`);
        // If it's the scanner, we might want to restart it after an error
        if (html5QrCode.getState() !== 2) setTimeout(() => startScanner(), 3000);
    }
}

async function startScanner() {
    startBtn.classList.add('hidden');
    statusDiv.innerHTML = '<p class="text-sm text-blue-600">Starting camera...</p>';

    try {
        await html5QrCode.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: { width: 250, height: 250 } },
            async (decodedText) => {
                await html5QrCode.stop().catch(() => {});
                await submitAttendance(decodedText);
            },
            () => { /* scanning... */ }
        );
        statusDiv.innerHTML = '<p class="text-sm text-green-600">‚úì Camera ready</p>';
    } catch (err) {
        statusDiv.innerHTML = '<p class="text-sm text-red-600">‚ùå Camera access denied.</p>';
        startBtn.classList.remove('hidden');
    }
}

startBtn.addEventListener('click', startScanner);

// Manual Form Logic
document.getElementById('manualForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const code = document.getElementById('manualCode').value.trim();
    if (!code) return;

    // Stop scanner if it's running
    await html5QrCode.stop().catch(() => {});
    await submitAttendance(code);
});
</script>
{% endblock %}